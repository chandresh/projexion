<div id="content">
    <p class="success"><span ><%= flash[:notice] %></span></p>
    
    <div id="feature" style="float:left; width:45%;">
      <div class="card">
        <div class="title"><strong>Business value</strong></div>
        <h2><%= h @feature.business_value %></h2>
      </div>

      <div class="card">
        <div class="title"><strong>Estimate size</strong></div>
        <h2 style="text-align:center"><%= h @feature.estimate_size %></h2>
      </div>

      <div class="card">
        <div class="title"><strong>Priority value</strong></div>
        <h2 style="text-align:center"><%= h @feature.priority %></h2>
      </div>

      <div style="clear:both; margin-bottom:1em;"></div>

      <% if @feature.release %>
      <p>

        <%= label_tag (:release) %><br/>
        <%= link_to @feature.release.version_number, project_release_features_path(@project.code, @feature.release.id) %>
        <%# TODO: Edit release. Only future release. %>
      </p>
      <% else %>
      <p class="info">
        No release has been assigned to this feature.
        <%# TODO: Add combo to assign release. Only future release %>
      </p>
      <% end %>

      <% if @feature.sprint %>
      <p>
        <%= label_tag (:sprint) %><br/>
        <%= link_to @feature.sprint.span_date, project_sprint_features_path(@project.code, @feature.sprint.id) %>
        <%# TODO: Edit sprint. Only future sprint. %>
      </p>
      <% else %>
      <p class="info">
        This feature is not in a sprint.
        <%# TODO: Add to next sprint button. Make sure next sprint has been created. %>
      </p>
      <% end %>

      <p>
        <%= label_tag (:user_story) %><br/>
        <%= h @feature.user_story %>
      </p>

      <p>
        <%= label_tag (:acceptance_test) %><br/>
        <%= h @feature.acceptance_test %>
      </p>
    </div>

    <script type="text/javascript">

      $(document).ready(function(){

        $('.desc').inlineEdit({
            'url': "<%= url_for :action => :update_desc, :controller => :tasks %>"
        });

        <%# TODO: Generalize this and make a jQuery extension for it? %>
        var click_status = function(){
            var tid = $(this).parent('tr').attr('value');
            
            var clone = $(this).clone();
            var current = $(this);
            
            $.getJSON("<%= url_for :action => :get_statuses, :controller => :tasks %>", function(data){
                var replacement = "<select>";
                $.each(data, function(i, value) {
                    replacement = replacement.concat("<option value="+value.task_status.id +">");
                    replacement = replacement.concat(value.task_status.display_name + "</option>");
                });
                replacement = replacement.concat("</select>");

                clone = clone.empty().css('background-color','white').append(replacement);
                current.replaceWith(clone);

                $(".status option").click(function () {
                    var status_id = $(this).val();

                    $.post("<%= url_for :action => :update_status, :controller => :tasks %>",
                        {"status_id": status_id, "id": tid },
                        callback_status, "json");
                });
            });
        };

        $('.status').click(click_status);

        var callback_status = function(data){
            var task_status = data.task_status.task_status;
            var task = data.task.task;
            
            var original = $('#task_' + task.id + " .status");
            var clone = original.clone();
            clone = clone.empty().append(task_status.display_name);
            clone.css('background-color', task_status.color);
            clone.click(click_status);
            original.replaceWith(clone);
        }

      });
      
    </script>

    <div style="float:left; margin-left:1em; width:45%">  
    <h2>Tasks for this feature</h2>

    <table id="tasks" width="100%">
    <% for task in @tasks %>
        <tr id="task_<%= h task.id %>" class="id" value="<%= h task.id %>">
            <td width="60%" class="desc"><%= h task.description %></td>
            <td width="20%" class="status <%= h task.task_status.key %>" style="background-color:<%= h task.task_status.color %>">
              <input type="hidden" class="tsid" name="task_status_id" value="<%= h task.task_status.id %>" />
              <span><%= h task.task_status.display_name %></span>
            </td>
            <td width="10%" style="text-align:center;"><%# TODO: link image background should not be black %>
                <% link_to project_feature_task_path(@project.code, @feature.id, task.id),
                            :confirm => 'Are you sure?', :method => :delete do %>
                    <img src="/images/icons/delete.png">
                <% end %>
            </td>
        </tr>
    <% end %>      
    </table>
    </div>
</div>

<div id="sidebar">
  <ul>
    <li><%= link_to 'Project Dashboard', project_path(@project.code), :class => 'dashboard' %></li>
    <li><%= link_to 'Edit Feature', edit_project_feature_path(@project.code, @feature.id), :class => 'edit' %></li>
    <li><%= link_to 'Delete Feature', project_feature_path(@project.code, @feature.id),
                :confirm => 'Are you sure?', :method => :delete, :class => 'delete' %></li>
    <li><%= link_to 'Add Task', new_project_feature_task_path(@project.code, @feature.id), :class => 'add', :rel => 'facebox' %></li>
  </ul>
</div>